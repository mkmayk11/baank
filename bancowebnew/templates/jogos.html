{% extends "base.html" %}
{% block conteudo %}
<div class="casino-background py-5">
  <div class="container">
    <div class="row justify-content-center g-4">

      <!-- üé∞ CA√áA-N√çQUEL -->
      <div class="col-md-6">
        <div class="card p-4 text-center shadow-lg slot-card">
          <h2 class="mb-3">üé∞ Ca√ßa-N√≠quel</h2>
          <form method="POST" action="{{ url_for('jogos') }}" id="formCaca">
            <input type="number" name="aposta_caca" id="apostaCaca" step="0.01"
              value="{{ last_aposta_caca }}" placeholder="Valor da aposta" required class="form-control mb-2">
            <input type="number" name="lote" id="lote" value="{{ last_lote }}"
              placeholder="Qtd rodadas (opcional)" class="form-control mb-3">

            <button type="submit" class="btn btn-neon w-100">Girar üé∞</button>
          </form>

          <div id="slotMachine" class="slot-machine mt-4">
            <div class="reel" id="reel1">{{ slot1 if slot1 else "‚ùî" }}</div>
            <div class="reel" id="reel2">{{ slot2 if slot2 else "‚ùî" }}</div>
            <div class="reel" id="reel3">{{ slot3 if slot3 else "‚ùî" }}</div>
          </div>

          {% if resultado_caca %}
            <div class="alert alert-info mt-3">{{ resultado_caca }}</div>
          {% endif %}
        </div>
      </div>

      <!-- üé° ROLETA -->
      <div class="col-md-6">
        <div class="card p-4 text-center shadow-lg roulette-card">
          <h2 class="mb-3">üé° Roleta</h2>
          <form method="POST" action="{{ url_for('jogos') }}" id="formRoleta">
            <input type="number" name="aposta_roleta" id="apostaRoleta" step="0.01"
              value="{{ last_aposta_roleta }}" placeholder="Valor da aposta" required class="form-control mb-2">

            <input type="number" name="numero_aposta" id="numeroAposta" min="0" max="36"
              value="{{ last_numero_aposta }}" placeholder="N√∫mero apostado (0-36)" class="form-control mb-3">

            <button type="submit" class="btn btn-neon w-100">Rodar üé°</button>
          </form>

          <div class="roulette-container mt-4">
            <div class="roulette-wrapper">
              <canvas id="rouletteCanvas" width="300" height="300"></canvas>
              <div class="roulette-pointer">‚ñº</div>
            </div>
            <div id="rouletteResult" class="mt-3"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<style>
  body {
    background: radial-gradient(circle at center, #111 0%, #000 100%);
    color: #fff;
  }
  .card {
    border-radius: 20px;
    background: rgba(20,20,20,0.95);
    border: 1px solid #444;
  }
  .btn-neon {
    background: linear-gradient(45deg, #0ff, #0f0);
    color: #000;
    font-weight: bold;
    border-radius: 12px;
    transition: 0.2s;
  }
  .btn-neon:hover {
    transform: scale(1.05);
    box-shadow: 0 0 20px #0f0;
  }

  /* üé∞ SLOT MACHINE */
  .slot-machine {
    display: flex;
    justify-content: center;
    gap: 10px;
  }
  .reel {
    width: 70px;
    height: 70px;
    background: #111;
    border: 2px solid #0f0;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.2rem;
    color: #0f0;
    box-shadow: inset 0 0 10px #0f0;
  }

  /* üé° ROLETA */
  .roulette-container {
    position: relative;
    margin: auto;
  }
  .roulette-wrapper {
    position: relative;
    display: inline-block;
  }
  #rouletteCanvas {
    border-radius: 50%;
    border: 5px solid #0f0;
    box-shadow: 0 0 20px #0f0;
  }
  .roulette-pointer {
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 2rem;
    color: #ff0;
    text-shadow: 0 0 5px #000, 0 0 10px #ff0;
  }
</style>

<script>
  // üé∞ Slot Machine
  const symbols = ["üçí","üçã","üîî","‚≠ê","üíé","üçÄ","üçâ","ü•≠","üçá","üçå","üçì","üçë","üçç","ü•ù","ü••","üçà","üåà","üé≤"];

  async function spinReel(reelId, delay, finalSymbol) {
    return new Promise(resolve => {
      const reel = document.getElementById(reelId);
      let i = 0;
      const interval = setInterval(() => {
        reel.textContent = symbols[i % symbols.length];
        i++;
      }, 100);
      setTimeout(() => {
        clearInterval(interval);
        reel.textContent = finalSymbol;
        resolve(finalSymbol);
      }, delay);
    });
  }

  async function startSlot(results) {
    await spinReel("reel1", 1500, results[0]);
    await spinReel("reel2", 2500, results[1]);
    await spinReel("reel3", 3500, results[2]);
  }

  document.getElementById("formCaca").addEventListener("submit", e => {
    e.preventDefault();
    // pega resultados j√° renderizados pelo backend
    const results = [
      "{{ slot1 if slot1 else 'üçí' }}",
      "{{ slot2 if slot2 else 'üçã' }}",
      "{{ slot3 if slot3 else '‚≠ê' }}"
    ];
    startSlot(results).then(() => e.target.submit());
  });

  // üé° Roleta
  const canvas = document.getElementById("rouletteCanvas");
  const ctx = canvas.getContext("2d");
  const segments = Array.from({length: 37}, (_, i) => i.toString());
  const colors = segments.map((_, i) => i === 0 ? "#0f0" : (i % 2 === 0 ? "#f00" : "#000"));
  let angle = 0, spinning = false;

  function drawRoulette() {
    const radius = canvas.width / 2;
    const segmentAngle = (2 * Math.PI) / segments.length;
    for (let i = 0; i < segments.length; i++) {
      ctx.beginPath();
      ctx.moveTo(radius, radius);
      ctx.arc(radius, radius, radius, i * segmentAngle, (i + 1) * segmentAngle);
      ctx.fillStyle = colors[i];
      ctx.fill();
      ctx.save();
      ctx.translate(radius, radius);
      ctx.rotate(i * segmentAngle + segmentAngle / 2);
      ctx.fillStyle = "#fff";
      ctx.font = "14px Arial";
      ctx.textAlign = "center";
      ctx.fillText(segments[i], radius * 0.75, 5);
      ctx.restore();
    }
  }

  function spinRoulette() {
    if (spinning) return;
    spinning = true;

    const winningIndex = Math.floor(Math.random() * segments.length);
    const segmentAngle = (2 * Math.PI) / segments.length;
    const targetAngle = angle + (2 * Math.PI * 6) + (winningIndex * segmentAngle);

    let speed = 0.4;
    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.translate(canvas.width / 2, canvas.height / 2);
      ctx.rotate(angle);
      ctx.translate(-canvas.width / 2, -canvas.height / 2);
      drawRoulette();
      ctx.restore();

      if (angle < targetAngle) {
        angle += speed;
        if (targetAngle - angle < 2) speed *= 0.97; // desacelera√ß√£o
        requestAnimationFrame(animate);
      } else {
        spinning = false;
        document.getElementById("rouletteResult").innerText = "Resultado: " + segments[winningIndex];
      }
    }
    animate();
  }

  drawRoulette();

  document.getElementById("formRoleta").addEventListener("submit", e => {
    e.preventDefault();
    spinRoulette();
    setTimeout(() => e.target.submit(), 5000);
  });
</script>
{% endblock %}
