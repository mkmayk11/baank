{% extends "base.html" %}
{% block conteudo %}
<div class="casino-background py-5">
  <div class="container">
    <div class="row justify-content-center g-4">

      <!-- 🎰 CAÇA-NÍQUEL -->
      <div class="col-md-6">
        <div class="card p-4 text-center shadow-lg slot-card">
          <h2 class="mb-3">🎰 Caça-Níquel</h2>
          <form method="POST" action="{{ url_for('jogos') }}" id="formCaca">
            <input type="number" name="aposta_caca" id="apostaCaca" step="0.01"
              value="{{ last_aposta_caca }}" placeholder="Valor da aposta" required class="form-control mb-2">
            <input type="number" name="lote" id="lote" value="{{ last_lote }}"
              placeholder="Qtd rodadas (opcional)" class="form-control mb-3">

            <button type="submit" class="btn btn-neon w-100">Girar 🎰</button>
          </form>

          <div id="slotMachine" class="slot-machine mt-4">
            <div class="reel" id="reel1"></div>
            <div class="reel" id="reel2"></div>
            <div class="reel" id="reel3"></div>
          </div>

          {% if resultado_caca %}
            <div class="alert alert-info mt-3">{{ resultado_caca }}</div>
          {% endif %}
        </div>
      </div>

      <!-- 🎡 ROLETA -->
      <div class="col-md-6">
        <div class="card p-4 text-center shadow-lg roulette-card">
          <h2 class="mb-3">🎡 Roleta</h2>
          <form method="POST" action="{{ url_for('jogos') }}" id="formRoleta">
            <input type="number" name="aposta_roleta" id="apostaRoleta" step="0.01"
              value="{{ last_aposta_roleta }}" placeholder="Valor da aposta" required class="form-control mb-2">

            <input type="number" name="numero_aposta" id="numeroAposta" min="0" max="36"
              value="{{ last_numero_aposta }}" placeholder="Número apostado (0-36)" class="form-control mb-3">

            <button type="submit" class="btn btn-neon w-100">Rodar 🎡</button>
          </form>

          <div class="roulette-container mt-4">
            <canvas id="rouletteCanvas" width="300" height="300"></canvas>
            <div id="rouletteResult" class="mt-3"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<style>
  body {
    background: radial-gradient(circle at center, #111 0%, #000 100%);
    color: #fff;
  }
  .card {
    border-radius: 20px;
    background: rgba(20,20,20,0.95);
    border: 1px solid #444;
  }
  .btn-neon {
    background: linear-gradient(45deg, #0ff, #0f0);
    color: #000;
    font-weight: bold;
    border-radius: 12px;
    transition: 0.2s;
  }
  .btn-neon:hover {
    transform: scale(1.05);
    box-shadow: 0 0 20px #0f0;
  }

  /* 🎰 SLOT MACHINE */
  .slot-machine {
    display: flex;
    justify-content: center;
    gap: 10px;
  }
  .reel {
    width: 70px;
    height: 70px;
    background: #111;
    border: 2px solid #0f0;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.2rem;
    color: #0f0;
    box-shadow: inset 0 0 10px #0f0;
  }

  /* 🎡 ROLETA */
  .roulette-container {
    position: relative;
    margin: auto;
  }
  #rouletteCanvas {
    border-radius: 50%;
    border: 5px solid #0f0;
    box-shadow: 0 0 20px #0f0;
  }
</style>

<script>
  // 🎰 Slot Machine
  const symbols = [
        "🍒", "🍋", "🔔", "⭐", "💎", "🍀", "🍉", "🥭",
        "🍇", "🍌", "🍓", "🍑", "🍍", "🥝", "🥥", "🍈", "🌈", "🎲"
    ];

  // Agora o resultado será fixado e sincronizado com o backend
  async function startSlot() {
    const results = [
      symbols[Math.floor(Math.random() * symbols.length)],
      symbols[Math.floor(Math.random() * symbols.length)],
      symbols[Math.floor(Math.random() * symbols.length)]
    ];

    async function spinReelFixed(reelId, delay, finalSymbol) {
      return new Promise(resolve => {
        const reel = document.getElementById(reelId);
        let i = 0;
        const interval = setInterval(() => {
          reel.textContent = symbols[i % symbols.length];
          i++;
        }, 100);
        setTimeout(() => {
          clearInterval(interval);
          reel.textContent = finalSymbol;
          resolve(finalSymbol);
        }, delay);
      });
    }

    await spinReelFixed("reel1", 1500, results[0]);
    await spinReelFixed("reel2", 2500, results[1]);
    await spinReelFixed("reel3", 3500, results[2]);

    return results;
  }

  document.getElementById("formCaca").addEventListener("submit", e => {
    e.preventDefault();
    startSlot().then(() => e.target.submit());
  });

  // 🎡 Roleta
  const canvas = document.getElementById("rouletteCanvas");
  const ctx = canvas.getContext("2d");
  const segments = Array.from({length: 37}, (_, i) => i.toString()); // números 0-36
  const colors = segments.map((_, i) => i % 2 === 0 ? "#0f0" : "#f00"); // verde/vermelho alternado
  let angle = 0, spinning = false, targetAngle = 0;

  function drawRoulette() {
    const radius = canvas.width / 2;
    const segmentAngle = (2 * Math.PI) / segments.length;
    for (let i = 0; i < segments.length; i++) {
      ctx.beginPath();
      ctx.moveTo(radius, radius);
      ctx.arc(radius, radius, radius, i * segmentAngle, (i + 1) * segmentAngle);
      ctx.fillStyle = colors[i % colors.length];
      ctx.fill();
      ctx.save();
      ctx.translate(radius, radius);
      ctx.rotate(i * segmentAngle + segmentAngle / 2);
      ctx.fillStyle = "#000";
      ctx.font = "16px Arial";
      ctx.textAlign = "center";
      ctx.fillText(segments[i], radius * 0.75, 5);
      ctx.restore();
    }
  }

  function spinRoulette() {
    if (spinning) return;
    spinning = true;

    // escolher número vencedor
    const winningIndex = Math.floor(Math.random() * segments.length);
    const segmentAngle = (2 * Math.PI) / segments.length;
    targetAngle = (2 * Math.PI * 5) + (winningIndex * segmentAngle); // 5 voltas + parar no número

    let speed = 0.35;
    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.translate(canvas.width / 2, canvas.height / 2);
      ctx.rotate(angle);
      ctx.translate(-canvas.width / 2, -canvas.height / 2);
      drawRoulette();
      ctx.restore();

      if (angle < targetAngle) {
        angle += speed;
        if (targetAngle - angle < 1) speed *= 0.97; // suaviza desaceleração
        requestAnimationFrame(animate);
      } else {
        spinning = false;
        document.getElementById("rouletteResult").innerText = "Resultado: " + segments[winningIndex];
      }
    }
    animate();
  }

  document.getElementById("formRoleta").addEventListener("submit", e => {
    e.preventDefault();
    spinRoulette();
    e.target.submit();
  });

  drawRoulette();
</script>
{% endblock %}

