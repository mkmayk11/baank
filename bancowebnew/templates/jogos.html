{% extends "base.html" %}
{% block conteudo %}
<div class="casino-background py-5">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="text-white">üé≤ Maask Cassino üé≤ </h2>
      <div id="saldoBox" class="px-3 py-2" style="background: rgba(0,0,0,0.4); border-radius:12px; border:1px solid #2f2;">
        <strong>Saldo:</strong> R$ {{ '%.2f' % saldo }}
      </div>
    </div>

    <div class="row justify-content-center g-4">

      <!-- üé∞ CA√áA-N√çQUEL -->
      <div class="col-md-6">
        <div class="card p-4 text-center shadow-lg slot-card">
          <h2 class="mb-3">üé∞ Ca√ßa-N√≠quel</h2>
          <form id="formCaca">
            <input type="number" name="aposta_caca" id="apostaCaca" step="0.01"
              value="{{ last_aposta_caca }}" placeholder="Valor da aposta" required class="form-control mb-2">
            <input type="number" name="lote" id="lote" value="{{ last_lote }}"
              placeholder="Qtd rodadas (opcional)" class="form-control mb-3">
            <button type="submit" class="btn btn-neon w-100">Girar üé∞</button>
          </form>

          <div id="slotMachine" class="slot-machine mt-4">
            <div class="reel" id="reel1">‚ùî</div>
            <div class="reel" id="reel2">‚ùî</div>
            <div class="reel" id="reel3">‚ùî</div>
          </div>
          <div id="slotResultado" class="alert alert-info mt-3" style="display:none;"></div>
          <div id="rodadasRestantes" class="text-white mt-2" style="font-size:0.9rem;"></div>
        </div>
      </div>

      <!-- üé° ROLETA -->
      <div class="col-md-6">
        <div class="card p-4 text-center shadow-lg roulette-card">
          <h2 class="mb-3">üé° Roleta</h2>
          <form id="formRoleta">
            <input type="number" name="aposta_roleta" id="apostaRoleta" step="0.01"
              value="{{ last_aposta_roleta }}" placeholder="Valor da aposta" required class="form-control mb-2">
            <input type="number" name="numero_roleta" id="numeroAposta" min="0" max="20"
              value="{{ last_numero_aposta }}" placeholder="N√∫mero apostado (0-20)" class="form-control mb-3">
            <button type="submit" class="btn btn-neon w-100">Rodar üé°</button>
          </form>

          <div class="roulette-container mt-4">
            <div class="roulette-wrapper">
              <canvas id="rouletteCanvas" width="300" height="300"></canvas>
              <div class="roulette-pointer">‚ñº</div>
            </div>
            <div id="rouletteResult" class="mt-3 text-white"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<style>
  body { background: radial-gradient(circle at center, #111 0%, #000 100%); color: #fff; }
  .card { border-radius: 20px; background: rgba(20,20,20,0.95); border: 1px solid #444; }
  .btn-neon { background: linear-gradient(45deg, #0ff, #0f0); color: #000; font-weight: bold; border-radius: 12px; transition: 0.2s; }
  .btn-neon:hover { transform: scale(1.05); box-shadow: 0 0 20px #0f0; }
  .slot-machine { display: flex; justify-content: center; gap: 10px; }
  .reel { width: 70px; height: 70px; background: #111; border: 2px solid #0f0; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; color: #0f0; box-shadow: inset 0 0 10px #0f0; }
  .roulette-container { position: relative; margin: auto; }
  .roulette-wrapper { position: relative; display: inline-block; }
  #rouletteCanvas { border-radius: 50%; border: 5px solid #0f0; box-shadow: 0 0 20px #0f0; background: #111; }
  .roulette-pointer { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 2rem; color: #ff0; text-shadow: 0 0 5px #000, 0 0 10px #ff0; }
</style>

<script>
const symbols = ["üçí","üçã","üîî","‚≠ê","üíé","üçÄ","üçâ","ü•≠","üçá","üçå","üçì","üçë","üçç","ü•ù","ü••","üçà","üåà","üé≤"];
const slotSound = new Audio("https://freesound.org/data/previews/256/256113_3263906-lq.mp3");
const rouletteSound = new Audio("https://freesound.org/data/previews/146/146727_2615111-lq.mp3");

// -------------------- SLOTS --------------------
async function spinReel(reelId, finalSymbol){
  return new Promise(resolve=>{
    const reel=document.getElementById(reelId);
    let i=0;
    let elapsed=0;
    const duration=1500;
    const interval=50;

    const intervalId=setInterval(()=>{
      reel.textContent=symbols[i%symbols.length];
      slotSound.currentTime=0;
      slotSound.play();
      i++;
      elapsed+=interval;
      if(elapsed>=duration){
        clearInterval(intervalId);
        reel.textContent = finalSymbol;
        resolve();
      }
    }, interval);
  });
}

async function startSlot(rolos, resultado, saldoFinal, rodadasRestantes){
  document.getElementById("slotResultado").style.display="none";
  await spinReel("reel1", rolos[0]);
  await spinReel("reel2", rolos[1]);
  await spinReel("reel3", rolos[2]);
  document.getElementById("slotResultado").style.display="block";
  document.getElementById("slotResultado").innerText=resultado;
  document.getElementById("saldoBox").innerText="R$ "+saldoFinal.toFixed(2);
  document.getElementById("rodadasRestantes").innerText=rodadasRestantes>0?`Jogadas restantes: ${rodadasRestantes}`:"";
}

async function runSlots(aposta,lote){
  for(let i=0;i<lote;i++){
    const resp=await fetch("{{ url_for('jogos') }}",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({tipo:"caca",aposta,lote:1})
    });
    const data=await resp.json();
    await startSlot(data.rolos,data.resultado,data.saldo,lote-i-1);
    await new Promise(res=>setTimeout(res,1000));
  }
}

document.getElementById("formCaca").addEventListener("submit",async e=>{
  e.preventDefault();
  const aposta=parseFloat(document.getElementById("apostaCaca").value);
  const lote=parseInt(document.getElementById("lote").value)||1;
  runSlots(aposta,lote);
});

// -------------------- ROLETA --------------------
const canvas=document.getElementById("rouletteCanvas");
const ctx=canvas.getContext("2d");
const segments=Array.from({length:21},(_,i)=>i);
let angle=0,spinning=false;

function drawRoulette(baseAngle=angle){
  const radius=canvas.width/2;
  const segmentAngle=(2*Math.PI)/segments.length;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  ctx.translate(radius,radius);
  ctx.rotate(baseAngle-segmentAngle/2-Math.PI/2);
  for(let i=0;i<segments.length;i++){
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,radius,i*segmentAngle,(i+1)*segmentAngle);
    ctx.fillStyle="#111";
    ctx.fill();
    ctx.strokeStyle="#0f0";
    ctx.stroke();

    ctx.save();
    ctx.rotate(i*segmentAngle+segmentAngle/2);
    ctx.fillStyle="#fff";
    ctx.font="16px Arial";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(segments[i].toString(),radius*0.65,0);
    ctx.restore();
  }
  ctx.restore();
}

function animateRouletteToIndex(winningIndex, saldoFinal, resultadoTexto, numeroEscolhido=null, aposta=null){
  if(spinning) return;
  spinning=true;

  const segmentAngle=(2*Math.PI)/segments.length;
  const spins=6;
  const finalAngle = spins*2*Math.PI + winningIndex*segmentAngle;
  let currentAngle = angle;
  let speed = 0.25;

  function step(){
    if(currentAngle < finalAngle){
      currentAngle += speed;
      speed *= 0.995; // desacelera√ß√£o suave
      drawRoulette(currentAngle);
      rouletteSound.currentTime=0;
      rouletteSound.play();
      requestAnimationFrame(step);
    } else {
      angle = finalAngle % (2*Math.PI);
      spinning=false;
      drawRoulette(angle);

      const numeroFinal=winningIndex;
      let resultadoFinal=`N√∫mero: ${numeroFinal} ‚Üí Caiu ${numeroFinal}. ${resultadoTexto.split('‚Üí')[1]?resultadoTexto.split('‚Üí')[1].trim():resultadoTexto}`;
      if(numeroEscolhido!==null && aposta!==null && numeroFinal===numeroEscolhido){
        resultadoFinal += ` üéâ Acertou! Pr√™mio x36 = R$ ${(aposta*36).toFixed(2)}`;
      }

      document.getElementById("rouletteResult").innerText = resultadoFinal;
      document.getElementById("saldoBox").innerText = "R$ "+saldoFinal.toFixed(2);
    }
  }
  requestAnimationFrame(step);
}

drawRoulette();

document.getElementById("formRoleta").addEventListener("submit",async e=>{
  e.preventDefault();
  const aposta=parseFloat(document.getElementById("apostaRoleta").value);
  const numero=parseInt(document.getElementById("numeroAposta").value);

  const resp = await fetch("{{ url_for('jogos') }}",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({tipo:"roleta",aposta,numero})
  });

  const data = await resp.json();
  animateRouletteToIndex(data.numero, data.saldo, data.resultado, numero, aposta);
});
</script>
{% endblock %}
