{% extends "base.html" %}
{% block conteudo %}
<div class="container py-5">
  <div class="row">
    <!-- ROLETINHA -->
    <div class="col-md-6 text-center">
      <div class="card shadow-lg p-4">
        <h2>ðŸŽ¡ Roleta Realista</h2>
        <canvas id="roletaCanvas" width="300" height="300"></canvas>
        <form method="POST" class="mt-3">
          <input type="number" step="0.01" name="aposta_roleta" placeholder="Valor da aposta" required>
          <select name="cor_roleta">
            <option value="vermelho">Vermelho</option>
            <option value="preto">Preto</option>
          </select>
          <button type="submit" class="btn btn-danger">Girar</button>
        </form>
        {% if resultado_roleta %}
          <div class="alert alert-info mt-3">{{ resultado_roleta }}</div>
        {% endif %}
      </div>
    </div>

    <!-- CAÃ‡A-NÃQUEL -->
    <div class="col-md-6 text-center">
      <div class="card shadow-lg p-4">
        <h2>ðŸŽ° CaÃ§a-NÃ­quel Premium</h2>
        <div id="rolos" class="d-flex justify-content-center mb-3 fs-1">
          {% for r in rolos %}
            <div class="mx-2">{{ r }}</div>
          {% endfor %}
        </div>

        <form method="POST" id="formCaca">
          <input type="number" step="0.01" name="aposta_caca" id="apostaCaca"
                 value="{{ request.form.aposta_caca or '' }}"
                 placeholder="Valor da aposta" required>
          <input type="number" name="lote" id="lote" placeholder="Qtd rodadas (opcional)">
          <button type="submit" class="btn btn-success">Girar</button>
        </form>

        {% if resultado_caca %}
          <div class="alert alert-info mt-3">{{ resultado_caca }}</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
/* ------------------ ROLETA ------------------ */
const canvas = document.getElementById("roletaCanvas");
if (canvas) {
  const ctx = canvas.getContext("2d");
  const radius = canvas.width / 2;
  const setores = 37; // 0 a 36
  let angulo = 0;
  let girando = false;

  function desenharRoleta() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let i = 0; i < setores; i++) {
      const start = (i * 2 * Math.PI) / setores + angulo;
      const end = ((i + 1) * 2 * Math.PI) / setores + angulo;
      ctx.beginPath();
      ctx.moveTo(radius, radius);
      ctx.arc(radius, radius, radius, start, end);
      ctx.fillStyle = i % 2 === 0 ? "red" : "black";
      ctx.fill();
      ctx.stroke();
    }
    ctx.beginPath();
    ctx.moveTo(radius, 0);
    ctx.lineTo(radius - 10, 20);
    ctx.lineTo(radius + 10, 20);
    ctx.closePath();
    ctx.fillStyle = "yellow";
    ctx.fill();
  }

  function girarRoleta() {
    if (girando) return;
    girando = true;
    let velocidade = Math.random() * 0.3 + 0.25;
    const desacel = 0.0005;

    function animar() {
      if (velocidade > 0) {
        angulo += velocidade;
        velocidade -= desacel;
        desenharRoleta();
        requestAnimationFrame(animar);
      } else {
        girando = false;
      }
    }
    animar();
  }

  desenharRoleta();
  document.querySelector("form[method='POST']").addEventListener("submit", girarRoleta);
}

/* ------------------ CAÃ‡A-NÃQUEL ------------------ */
document.getElementById("formCaca").addEventListener("submit", (e) => {
  const lote = document.getElementById("lote").value;
  if (lote && parseInt(lote) > 1) {
    e.preventDefault();
    let rodadas = parseInt(lote);
    const form = e.target;
    function rodada() {
      fetch(form.action, {
        method: "POST",
        body: new FormData(form)
      })
      .then(r => r.text())
      .then(html => {
        document.body.innerHTML = html;
        rodadas--;
        if (rodadas > 0) setTimeout(rodada, 1200);
      });
    }
    rodada();
  }
});
</script>
{% endblock %}
