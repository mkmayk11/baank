{% extends "base.html" %}
{% block conteudo %}
<div class="casino-background py-5">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="text-white">üé≤ Joguinhos</h2>
      <div class="px-3 py-2" style="background: rgba(0,0,0,0.4); border-radius:12px; border:1px solid #2f2;">
        <strong>Saldo:</strong> R$ {{ '%.2f' % saldo }}
      </div>
    </div>

    <div class="row justify-content-center g-4">

      <!-- üé∞ CA√áA-N√çQUEL -->
      <div class="col-md-6">
        <div class="card p-4 text-center shadow-lg slot-card">
          <h2 class="mb-3">üé∞ Ca√ßa-N√≠quel</h2>
          <form method="POST" action="{{ url_for('jogos') }}" id="formCaca">
            <input type="number" name="aposta_caca" id="apostaCaca" step="0.01"
              value="{{ last_aposta_caca }}" placeholder="Valor da aposta" required class="form-control mb-2">
            <input type="number" name="lote" id="lote" value="{{ last_lote }}"
              placeholder="Qtd rodadas (opcional)" class="form-control mb-3">

            <button type="submit" class="btn btn-neon w-100">Girar üé∞</button>
          </form>

          <div id="slotMachine" class="slot-machine mt-4">
            <div class="reel" id="reel1">{{ rolos[0] if rolos else "‚ùî" }}</div>
            <div class="reel" id="reel2">{{ rolos[1] if rolos else "‚ùî" }}</div>
            <div class="reel" id="reel3">{{ rolos[2] if rolos else "‚ùî" }}</div>
          </div>

          {% if resultado_caca %}
            <div class="alert alert-info mt-3">{{ resultado_caca }}</div>
          {% endif %}
        </div>
      </div>

      <!-- üé° ROLETA -->
      <div class="col-md-6">
        <div class="card p-4 text-center shadow-lg roulette-card">
          <h2 class="mb-3">üé° Roleta</h2>
          <form method="POST" action="{{ url_for('jogos') }}" id="formRoleta">
            <input type="number" name="aposta_roleta" id="apostaRoleta" step="0.01"
              value="{{ last_aposta_roleta }}" placeholder="Valor da aposta" required class="form-control mb-2">

            <!-- NOTE: name="numero_roleta" corresponde √† l√≥gica do Flask -->
            <input type="number" name="numero_roleta" id="numeroAposta" min="0" max="36"
              value="{{ last_numero_aposta }}" placeholder="N√∫mero apostado (0-36)" class="form-control mb-3">

            <button type="submit" class="btn btn-neon w-100">Rodar üé°</button>
          </form>

          <div class="roulette-container mt-4">
            <div class="roulette-wrapper">
              <canvas id="rouletteCanvas" width="300" height="300"></canvas>
              <div class="roulette-pointer">‚ñº</div>
            </div>
            <div id="rouletteResult" class="mt-3 text-white"></div>
            {% if resultado_roleta %}
              <div class="alert alert-info mt-2">{{ resultado_roleta }}</div>
            {% endif %}
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<style>
  body {
    background: radial-gradient(circle at center, #111 0%, #000 100%);
    color: #fff;
  }
  .card {
    border-radius: 20px;
    background: rgba(20,20,20,0.95);
    border: 1px solid #444;
  }
  .btn-neon {
    background: linear-gradient(45deg, #0ff, #0f0);
    color: #000;
    font-weight: bold;
    border-radius: 12px;
    transition: 0.2s;
  }
  .btn-neon:hover {
    transform: scale(1.05);
    box-shadow: 0 0 20px #0f0;
  }

  /* üé∞ SLOT MACHINE */
  .slot-machine {
    display: flex;
    justify-content: center;
    gap: 10px;
  }
  .reel {
    width: 70px;
    height: 70px;
    background: #111;
    border: 2px solid #0f0;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.2rem;
    color: #0f0;
    box-shadow: inset 0 0 10px #0f0;
  }

  /* üé° ROLETA */
  .roulette-container {
    position: relative;
    margin: auto;
  }
  .roulette-wrapper {
    position: relative;
    display: inline-block;
  }
  #rouletteCanvas {
    border-radius: 50%;
    border: 5px solid #0f0;
    box-shadow: 0 0 20px #0f0;
    background: #111;
  }
  .roulette-pointer {
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 2rem;
    color: #ff0;
    text-shadow: 0 0 5px #000, 0 0 10px #ff0;
  }
</style>

<script>
  // ‚ö† IMPORTANTE: esta lista deve bater com a lista `simbolos` do Flask.
  const symbols = ["üçí","üçã","üîî","‚≠ê","üíé","üçÄ","üçâ","ü•≠","üçá","üçå","üçì","üçë","üçç","ü•ù","ü••","üçà","üåà","üé≤"];

  async function spinReel(reelId, delay, finalSymbol) {
    return new Promise(resolve => {
      const reel = document.getElementById(reelId);
      let i = 0;
      const interval = setInterval(() => {
        reel.textContent = symbols[i % symbols.length];
        i++;
      }, 80);
      setTimeout(() => {
        clearInterval(interval);
        reel.textContent = finalSymbol;
        resolve(finalSymbol);
      }, delay);
    });
  }

  async function startSlot(results) {
    // results √© um array tipo ["üçí","üçã","‚≠ê"] vindo do servidor
    await spinReel("reel1", 900, results[0]);
    await spinReel("reel2", 1400, results[1]);
    await spinReel("reel3", 1900, results[2]);
  }

  /* -------------------- Roleta drawing + anima√ß√£o para n√∫mero do servidor -------------------- */
  const canvas = document.getElementById("rouletteCanvas");
  const ctx = canvas.getContext("2d");
  const segments = Array.from({length: 37}, (_, i) => i); // 0..36
  const colors = segments.map((_, i) => i === 0 ? "#0f0" : (i % 2 === 0 ? "#f00" : "#000"));
  let angle = 0, spinning = false;

  function drawRoulette() {
    const radius = canvas.width / 2;
    const segmentAngle = (2 * Math.PI) / segments.length;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    for (let i = 0; i < segments.length; i++) {
      ctx.beginPath();
      ctx.moveTo(radius, radius);
      ctx.arc(radius, radius, radius, i * segmentAngle, (i + 1) * segmentAngle);
      ctx.fillStyle = colors[i];
      ctx.fill();
      ctx.save();
      ctx.translate(radius, radius);
      ctx.rotate(i * segmentAngle + segmentAngle / 2);
      ctx.fillStyle = "#fff";
      ctx.font = "14px Arial";
      ctx.textAlign = "center";
      ctx.fillText(segments[i].toString(), radius * 0.75, 5);
      ctx.restore();
    }
  }

  function animateToIndex(winningIndex) {
    if (spinning) return;
    spinning = true;
    const segmentAngle = (2 * Math.PI) / segments.length;
    const targetAngle = angle + (2 * Math.PI * 6) + (winningIndex * segmentAngle);

    let speed = 0.4;
    function animate() {
      ctx.save();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.translate(canvas.width / 2, canvas.height / 2);
      ctx.rotate(angle);
      ctx.translate(-canvas.width / 2, -canvas.height / 2);
      drawRoulette();
      ctx.restore();

      if (angle < targetAngle) {
        angle += speed;
        if (targetAngle - angle < 2) speed *= 0.97;
        requestAnimationFrame(animate);
      } else {
        spinning = false;
        // mostra o resultado ao lado (se j√° n√£o estiver setado)
        // o backend j√° mostra uma mensagem textual em resultado_roleta, ent√£o esse div √© suplementar.
        document.getElementById("rouletteResult").innerText = "Resultado: " + winningIndex;
      }
    }
    animate();
  }

  drawRoulette();

  /* -------------------- Comportamento ao carregar (usa resultados do servidor) -------------------- */
  document.addEventListener("DOMContentLoaded", function() {
    // rolos vindo do servidor (array) ‚Äî template injeta aqui quando houver rolagem feita.
    const serverRolos = {{ rolos|tojson if rolos else 'null' }};
    if (serverRolos) {
      // anima para os s√≠mbolos que o servidor j√° calculou
      startSlot(serverRolos);
    }

    // resultado textual da roleta (ex: "üéâ N√∫mero 7! Voc√™ ganhou R$ 10.00!")
    const serverResultadoRoleta = {{ resultado_roleta|tojson if resultado_roleta else 'null' }};
    if (serverResultadoRoleta) {
      // exibe a mensagem textual (vinda do backend)
      document.getElementById("rouletteResult").innerText = serverResultadoRoleta;

      // tenta extrair o n√∫mero sorteado (0..36) da string do backend
      const match = serverResultadoRoleta.match(/\b([0-9]|[1-2][0-9]|3[0-6])\b/);
      if (match) {
        const numero = parseInt(match[0], 10);
        // anima a roleta para esse n√∫mero
        animateToIndex(numero);
      }
    }
  });
</script>
{% endblock %}
